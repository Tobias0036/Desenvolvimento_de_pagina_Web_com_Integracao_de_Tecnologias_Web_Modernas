<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Educa√ß√£o Financeira - Administra√ß√£o</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="estilo.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Educa√ß√£o Financeira</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Close navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Metas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="chat.html">Chat</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="budget.html">Or√ßamento</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="admin.html">Admin</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-custom">
        <div class="admin-container" id="loginContainer">
            <h2>üîê Login do Respons√°vel</h2>
            <form id="loginForm" class="name-form">
                <div class="mb-3">
                    <label for="adminName" class="form-label">Nome do Respons√°vel</label>
                    <input type="text" id="adminName" class="form-control" placeholder="Digite 'Responsavel'" required>
                </div>
                <div class="mb-3">
                    <label for="adminPassword" class="form-label">Senha</label>
                    <input type="password" id="adminPassword" class="form-control" placeholder="Digite a senha" required>
                </div>
                <div id="loginError" class="text-danger" style="display: none;"></div>
                <button type="submit" class="btn btn-primary">Entrar</button>
            </form>
        </div>
        <div class="admin-container" id="adminContainer" style="display: none;">
            <h2>üìä Painel de Administra√ß√£o</h2>
            <div class="row">
                <div class="col-md-4">
                    <h3>Usu√°rios Online</h3>
                    <ul id="onlineUsers" class="list-group"></ul>
                </div>
                <div class="col-md-4">
                    <h3>Hist√≥rico de Entradas/Sa√≠das</h3>
                    <div id="historyLog" class="history-box"></div>
                </div>
                <div class="col-md-4">
                    <h3>Responder Usu√°rio</h3>
                    <select id="userSelect" class="form-select mb-3">
                        <option value="">Selecione um usu√°rio</option>
                    </select>
                    <div id="adminChatBox" class="chat-box"></div>
                    <form id="adminChatForm" class="chat-form">
                        <input type="text" id="adminMessage" class="form-control" placeholder="Digite sua mensagem..." required>
                        <button type="submit" class="btn btn-primary">‚û§</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let ws;

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const adminName = document.getElementById('adminName').value.trim();
            const adminPassword = document.getElementById('adminPassword').value.trim();
            document.getElementById('loginError').style.display = 'none';
            connectWebSocket(adminName, adminPassword);
        });

        function connectWebSocket(adminName, adminPassword) {
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            ws = new WebSocket(protocol + window.location.host);

            ws.onopen = () => {
                ws.send(JSON.stringify({ type: 'setAdmin', name: adminName, password: adminPassword }));
                console.log('Tentativa de conex√£o como Respons√°vel.');
            };

            ws.onmessage = (evento) => {
                const data = JSON.parse(evento.data);
                if (data.tipo === 'admin_login_success') {
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('adminContainer').style.display = 'block';
                    console.log('Conectado ao WebSocket como Respons√°vel.');
                } else if (data.tipo === 'admin_login_error') {
                    document.getElementById('loginError').textContent = data.mensagem;
                    document.getElementById('loginError').style.display = 'block';
                    ws.close();
                } else if (data.tipo === 'usuarios_online') {
                    updateOnlineUsers(data.usuarios);
                } else if (data.tipo === 'historico') {
                    addHistoryLog(data.mensagem);
                } else if (data.tipo === 'mensagem_usuario') {
                    addAdminChatMessage(`${data.nome}: ${data.mensagem}`, 'usuario');
                }
            };

            ws.onclose = () => {
                console.log('Desconectado do WebSocket.');
                if (document.getElementById('adminContainer').style.display === 'block') {
                    document.getElementById('loginContainer').style.display = 'block';
                    document.getElementById('adminContainer').style.display = 'none';
                    document.getElementById('loginError').textContent = 'Conex√£o perdida. Fa√ßa login novamente.';
                    document.getElementById('loginError').style.display = 'block';
                }
            };

            ws.onerror = (error) => {
                console.error('Erro no WebSocket:', error);
                document.getElementById('loginError').textContent = 'Erro na conex√£o. Tente novamente.';
                document.getElementById('loginError').style.display = 'block';
            };

            document.getElementById('adminChatForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const mensagem = document.getElementById('adminMessage').value.trim();
                const userId = document.getElementById('userSelect').value;
                if (mensagem && userId && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'mensagem_responsavel', userId, mensagem }));
                    addAdminChatMessage(`Respons√°vel: ${mensagem}`, 'responsavel');
                    document.getElementById('adminMessage').value = '';
                }
            });
        }

        function updateOnlineUsers(usuarios) {
            const list = document.getElementById('onlineUsers');
            const select = document.getElementById('userSelect');
            list.innerHTML = '';
            select.innerHTML = '<option value="">Selecione um usu√°rio</option>';
            usuarios.forEach(u => {
                const li = document.createElement('li');
                li.className = `list-group-item ${u.status === 'Aguardando Respons√°vel' ? 'list-group-item-warning' : ''}`;
                li.textContent = `${u.nome} (${u.status})`;
                list.appendChild(li);

                const option = document.createElement('option');
                option.value = u.id;
                option.textContent = u.nome;
                if (u.status === 'Aguardando Respons√°vel') {
                    option.className = 'text-warning';
                }
                select.appendChild(option);
            });
        }

        function addHistoryLog(mensagem) {
            const div = document.createElement('div');
            div.textContent = mensagem;
            document.getElementById('historyLog').appendChild(div);
            document.getElementById('historyLog').scrollTop = document.getElementById('historyLog').scrollHeight;
        }

        function addAdminChatMessage(mensagem, tipo) {
            const div = document.createElement('div');
            div.className = `mensagem mensagem-${tipo}`;
            div.textContent = mensagem;
            document.getElementById('adminChatBox').appendChild(div);
            document.getElementById('adminChatBox').scrollTop = document.getElementById('adminChatBox').scrollHeight;
        }
    </script>
</body>
</html>